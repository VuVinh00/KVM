## Overlay Network

Overlay networking là công nghệ cho phép tạo ra các mạng ảo trên hệ thống mạng vật lý bên dưới ( underlay network ) mà không ảnh hưởng hoặc ảnh hưởng không đáng kể tới hạ tầng mạng bên dưới

Cụ thể hơn, với overlay network, ta có thể tạo ra các mạng ảo L2 trên nền hạ tầng mạng L3 network. Đứng ở góc độ cloud computing, các mạng L2 này là mạng riêng biệt của khách hàng, cách tiếp cận sử dụng mạng ảo overlay có nhiều ưu điểm hơn sử dụng L2-based hay VLAN. Nếu như với môi trường Cloud Computing khi mà số lượng máy ảo khách hàng trên các máy chủ vật lý càng ngày càng tăng với số lượng lớn theo thời gian kéo theo yêu cầu cô lập các mạng khách hàng thì nảy sinh vấn đề như : 

  - VLAN chỉ hỗ trợ 12 bit cho VLAN_ID nên nó bị giới hạn số lượng là 4096 VLAN_ID --> Không đủ VLAN cho datacenter để quản lý một số lượng lớn máy chủ chia sẻ cùng kiến trúc mạng L2/L3
  - Số lượng máy chủ vật lý, máy ảo lớn --> bảng địa chỉ MAC trên các switch rất lớn và có thể quá tải
  - Sử dụng STP để chống loop mạng --> dẫn đến chặn hầu hết các đường dự phòng, hạn chế tăng băng thông
  - Các VLAN cũng bị hạn chế về khoảng cách và triển khai
  
Chính những yếu tố trên đã dẫn đến sự ra đời của VXLAN ( virtual extensible LAN ) được thiết kể để cung cấp dịch vụ mạng L2 tương tự như VLAN nhưng có thể mở rộng và linh hoạt hơn.

VXLAN sử dụng 24 bit để đánh địa chỉ VLAN_ID, tức khoảng 16 triệu VLAN_ID. Điều này sẽ cung cấp đủ không gian để triển khai các quy mô mạng trong vài năm tới

## Các khái niệm trong VXLAN

## Lab VXLAN trên 2 host sử dụng Open vSwitch

### 1. Mô hình 

<img src="https://github.com/vjnkvt/Images/blob/master/labvxlan.png">

### 2. Cấu hình Host 1 

- Cài đặt OpenvSwitch

```
yum install wget openssl-devel  python-sphinx gcc make python-devel openssl-devel kernel-devel graphviz kernel-debug-devel autoconf automake rpm-build redhat-rpm-config libtool python-twisted-core python-zope-interface PyQt4 desktop-file-utils libcap-ng-devel groff checkpolicy selinux-policy-devel python-six -y 
useradd ovs
su - ovs
mkdir -p ~/rpmbuild/SOURCES
wget http://openvswitch.org/releases/openvswitch-2.9.2.tar.gz
cp openvswitch-2.9.2.tar.gz ~/rpmbuild/SOURCES/
tar xfz openvswitch-2.9.2.tar.gz
rpmbuild -bb --nocheck openvswitch-2.9.2/rhel/openvswitch-fedora.spec
exit
yum install -y /home/ovs/rpmbuild/RPMS/x86_64/openvswitch-2.9.2-1.el7.x86_64.rpm
```

- Cấu hình IPv4 Fowarding

```
cat <<EOF > /etc/sysctl.conf
net.ipv4.ip_forward = 1
EOF
sysctl -p /etc/sysctl.conf
```

- Cấu hình VXLAN Tunnel Endpoint

```
ovs-vsctl add-br br-extun
ovs-vsctl add-port br-extun tun-vxlan0 -- set interface tun-vxlan0 type=vxlan options:local_ip=10.0.10.133 options:remote_ip=10.0.10.136
```

- Cấu hình IP cho internal interface ( VETP ) 

```
cat <<EOF > /etc/sysconfig/network-scripts/ifcfg-extun
DEVICE=br-extun
BOOTPROTO=yes
ONBOOT=yes
PREFIX=24
IPADDR=192.168.199.1
EOF
systemctl restart network
```

- Khởi tạo một network mới trong libvirt

```
cat <<EOF > /etc/libvirt/qemu/networks/br-tun.xml

<network>
  <name>ovs-tun</name>
  <forward mode='bridge'/>
  <bridge name='br-extun'/>
  <virtualport type='openvswitch'/>
</network>

EOF
cd /etc/libvirt/qemu/networks
virsh net-define br-tun.xml
virsh net-start ovs-tun
virsh net-autostart ovs-tun
```

- Cấu hình network interface cho máy ảo 

```
   <interface type='network'>
      <mac address='52:54:00:e7:30:fc'/>
      <source network='ovs-tun'/>
      <model type='virtio'/>
      <address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/>
    </interface>
```

- Cấu hình IP cho máy ảo 

```
TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=none
IPADDR=192.168.199.20
PREFIX=24
GATEWAY=192.168.1.1
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=eth0
UUID=871cc080-ff63-4546-bd8b-bdbb2d60a9f5
DEVICE=eth0
ONBOOT=yes
```

### 3. Cấu hình host 2 

- Cài đặt OpenvSwitch

```
yum install wget openssl-devel  python-sphinx gcc make python-devel openssl-devel kernel-devel graphviz kernel-debug-devel autoconf automake rpm-build redhat-rpm-config libtool python-twisted-core python-zope-interface PyQt4 desktop-file-utils libcap-ng-devel groff checkpolicy selinux-policy-devel python-six -y 
useradd ovs
su - ovs
mkdir -p ~/rpmbuild/SOURCES
wget http://openvswitch.org/releases/openvswitch-2.9.2.tar.gz
cp openvswitch-2.9.2.tar.gz ~/rpmbuild/SOURCES/
tar xfz openvswitch-2.9.2.tar.gz
rpmbuild -bb --nocheck openvswitch-2.9.2/rhel/openvswitch-fedora.spec
exit
yum install -y /home/ovs/rpmbuild/RPMS/x86_64/openvswitch-2.9.2-1.el7.x86_64.rpm
```

- Cấu hình IPv4 Fowarding

```
cat <<EOF > /etc/sysctl.conf
net.ipv4.ip_forward = 1
EOF
sysctl -p /etc/sysctl.conf
```

- Cấu hình VXLAN Tunnel Endpoint

```
ovs-vsctl add-br br-extun
ovs-vsctl add-port br-extun tun-vxlan0 -- set interface tun-vxlan0 type=vxlan options:local_ip=10.0.10.136 options:remote_ip=10.0.10.133
```

- Cấu hình IP cho internal interface - VETP

```
cat <<EOF > /etc/sysconfig/network-scripts/ifcfg-extun
DEVICE=br-extun
BOOTPROTO=yes
ONBOOT=yes
PREFIX=24
IPADDR=192.168.199.2
EOF
systemctl restart network
```

